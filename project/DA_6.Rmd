---
title: "Predicting Medical Insurance Charges from Age, BMI and Smoking Status"
author: "DA Group 6"
output:
  pdf_document:
    latex_engine: pdflatex
    number_sections: yes
  word_document: default
  html_document:
    df_print: paged
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA)
options(scipen = 999)
```

```{r libraries}
library(ggplot2)
library(dplyr)
library(moderndive)
library(skimr)
library(tidyr)
library(kableExtra)
library(gridExtra)
library(GGally)
library(broom)
```


```{r data, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
insurance <- read.csv("insurance.csv")

insur <- insurance %>%
  filter(region == "southeast") %>%
  select(charges, age, bmi, smoker)
```

# Introduction {#sec:Intro}

In today's world, medical care is undoubtedly an expensive affair.  Consequently, numerous individuals enroll in a health insurance policy, where they agree to pay a sum of money (known as premiums) to a particular health insurance company, on a monthly or yearly basis.  In return, the company will guarantee to reimburse a proportion of the medical costs in case the insured is injured or sick and needs medical treatment. 

The amount of premium which an individual pays, depends on a number of factors.  In particular, the higher the risk of having health problems, the higher the premium would be.  For instance, overweight or obese persons are more likely to develop heart disease when compared with people of normal weight.  Moreover, smoking is linked with an increased risk of lung cancer when compared to individuals who do not smoke.  Apart from these, there is a tendency for health insurance rates to escalate with increasing age, since older people are more prone to health problems.  In these situations, one might expect these individuals to have a higher risk of large medical expenses.

The main goal of this report is to predict the total yearly medical costs (`charges`) billed by health insurance from the age of the individual (`age`), the corresponding body mass index (`bmi`) and from whether the insured smokes tobacco or not (`smoker`).  The `bmi` is a measure of body fat, which is defined as the body weight (in kg) divided by the square of the body height (in $m^2$).  The data analysed here consists of a sample of `r nrow(insur)` individuals living in the South East region of the United States, from `r nrow(insurance)` observations, which contain hypothetical data on medical expenses for patients in the United States.  The simulated data was based on the demographic statistics obtained from the US Census Bureau, and thus, it resembles real world data.  

Section \ref{sec:EDA} consists of an exploratory data analysis to gain a better understanding of the distribution of the features used under this study.  Section \ref {sec:FDA} provides the process of selecting the best regression model to predict the insurance charges after fitting a number of regression models to the data.  Moreover, the model assumptions are also checked here.  Finally, Section \ref{sec:Conc} sums up the results obtained after conducting this analysis.


# Exploratory Data Analysis {#sec:EDA}

To get an idea of the distribution of the data, the following summary statistics were obtained for the categorical variable `smoker` (Table \ref{tab:sum1}) and for the continuous variables `charges`, `age` and `bmi` (Table \ref{tab:sum2}).

```{r summary1, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}

insur %>%
  group_by(smoker) %>%
  summarise(n()) %>%
  kable(col.names = c("Smoker", "n"),
        caption = '\\label{tab:sum1} Numbers of smokers and non-smokers.', booktabs = TRUE, format = "latex") %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

As can be clearly seen from Table \ref{tab:sum1}, out of the `r nrow(insur)` individuals, the majority of them do not smoke (`r sum(insur$smoker=="no")` non smokers vs `r sum(insur$smoker=="yes")` smokers).  In fact, only one fourth of the individuals in the study smokes.  

```{r summary2, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}

insur$age <- as.numeric(insur$age)

skim_with(numeric = list(hist = NULL, missing = NULL, complete = NULL))
insur %>%
  skim_to_list() %>%
  .$numeric %>%
  kable(col.names = c("Variable", "n", "Mean", "SD", "Minimum", "1st quartile", "Median", "3rd quartile", "Maximum"),
        caption = '\\label{tab:sum2} Summary statistics on insurance charges, age and bmi.', booktabs = TRUE, format = "latex") %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

If we look at Table \ref{tab:sum2}, the mean age of the individuals is `r round(mean(insur$age), 2)` years, with a standard deviation (`SD`) of `r round(sd(insur$age), 2)` years.  Next, the middle 50% of the bmi lies between `r round(quantile(insur$bmi, 0.25), 2)` and `r round(quantile(insur$bmi, 0.75), 2)` $\mbox{kg/m}^{2}$, with an average bmi value of `r round(mean(insur$bmi), 2)` $\mbox{kg/m}^{2}$ and standard deviation `r round(sd(insur$bmi), 2)` $\mbox{kg/m}^{2}$.  Finally, the middle 50% of the data for the medical costs (charges) lies between `r round(quantile(insur$charges, 0.25), 2)` and `r round(quantile(insur$charges, 0.75), 2)` dollars, with an average of `r round(mean(insur$charges), 2)` dollars.  The variation in the mean total charges seems to be quite high, with a value of `r round(sd(insur$charges), 2)` dollars.

```{r corr.coef, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}
Cor.1 <- insur %>%
  get_correlation(formula = charges ~ age)

Cor.2 <- insur %>%
  get_correlation(formula = charges ~ bmi)

Cor.3 <- insur %>%
  get_correlation(formula = bmi ~ age)
```

In order to measure the degree of association between the continuous variables in the study, the pairs scatterplot is plotted in Figure \ref {fig:cor}. The plot shows that there is no strong relationship between any two continuous variables.  To confirm this, the correlation coefficients for each pair of variables was calculated.  The correlation between the response variable `charges` and the explanatory variables `age` and `bmi` were found to be `r round(Cor.1, 3)` and `r round(Cor.2, 3)`, respectively.  Moreover, there does not seem to be any linear association between the two continuous explanatory variables `age` and `bmi` (`r round(Cor.3, 3)`), implying that there is no evidence of multicollinearity in the data.
```{r correlation, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, out.width = '55%', fig.align="center", fig.pos="H", fig.cap = "\\label{fig:cor}Pairs plot between charges, age and bmi"}

d <- insur[,1:3]
pairs(d, color="lightseagreen")
```

Figure \ref{fig:scat} on the next page, shows two scatterplots of the insurance charges against each of the explanatory variables by smoking status of the individuals.  From the left hand plot, which shows the relationship between charges and age by the smoking status, it is evident that as people mature, the health insurance charge increases.  The plot indicates thata on average, people who do not smoke, pay less than 40000 dollar whereas smokers pay up to 60000 dollars on their health insurance. However, the associated effect of age does not seem to change differently between the smokers and non smokers.  On the other hand, the slopes of the lines of the right hand plot are distinct, and thus, bmi seems to change differently with the smoking status.  In particular, it appears from the plot that as the bmi of a smoker individual increases, the corresponding insurance charges increase drastically.  This is in contrast with those individuals who do not smoke, where a change in the bmi does not seem to make a significant change in the insurance charges.  To sum up it is clear from both plots that smoking people pay larger amounts on their health insurance when compared with those who do not smoke. 

To predict the medical insurance charges, a number of linear regression models will be fitted with age, bmi and smoking status as potential predictors.

```{r scatplot, fig.width=13, fig.pos = "H", fig.align = "center", fig.cap = "\\label{fig:scat}Scatterplots of insurance charges and age by smoking status (left) and insurance charges and bmi by smoking status (right)"}
p1 <- ggplot(insur, aes(x = age, y = charges, color = smoker)) +
  geom_point() +
  labs(x = "Age (in years)", y = "Insurance charges (in $)", color = "smoker") +
  geom_smooth(method = "lm", se = FALSE)

p2 <- ggplot(insur, aes(x = bmi, y = charges, color = smoker)) +
  geom_point() +
  labs(x = "bmi", y = "Insurance charges (in $)", color = "smoker") +
  geom_smooth(method = "lm", se = FALSE)

grid.arrange(p1, p2, ncol =2)
```

# Formal Data Analysis {#sec:FDA}

Initially, the full interaction model was fitted to this dataset.  Hence, this is given as follows:
$$y_i = \alpha + \beta_{\mbox{bmi}} \cdot \mbox{bmi}_{i} +\beta_{\mbox{age}} \cdot \mbox{age}_{i} + \beta_{\mbox{Smoker}} \cdot \mathbb{I}_{\mbox{Smoker}}(i) + \beta_{\mbox{bmi, smoker}} \cdot \mathbb{I}_{\mbox{bmi, smoker}}(i) + \beta_{\mbox{age, smoker}} \cdot \mathbb{I}_{\mbox{age, smoker}}(i) +\epsilon_i$$
where

- $\alpha$ is the intercept of the regression line for non-smokers;
- $\beta_{\mbox{bmi}}$ is the slope of the regression line for both smokers and non-smokers;
- $\mbox{bmi}_{i}$ is the bmi of the $i^{th}$ observation
- $\beta_{\mbox{age}}$ is the slope of the regression line for both smokers and non-smokers;
- $\mbox{age}_{i}$ is the age of the $i^{th}$ observation
- $\beta_{\mbox{Smoker}}$ is the additional term added to $\alpha$ to get the intercept of the regression line for smokers; and
- $\mathbb{I}_{\mbox{Smoker}}(i)$ is an indicator function such that

$$\mathbb{I}_{\mbox{Smoker}}(i)=\left\{
\begin{array}{ll}
1 ~~~ \mbox{if the} ~ i \mbox{th observation smokes}, \\
0 ~~~ \mbox{Otherwise}.\\
\end{array}
\right.$$

Also, $\beta_{\mbox{bmi, smoker}} \cdot \mathbb{I}_{\mbox{bmi, smoker}}(i)$ and $\beta_{\mbox{age, smoker}} \cdot \mathbb{I}_{\mbox{age, smoker}}(i)$ correspond to the interaction terms.

The parameter estimates obtained after fitting the above full model are summarised in Table \ref{tab:fullmodel}.


```{r full, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}

model1 <- lm(charges ~ age + bmi + smoker + age*smoker + bmi*smoker, data = insur)

get_regression_table(model1) %>%
  kable(digits = 3, caption = '\\label{tab:fullmodel} Parameter estimates obtained from the full model charges = age + bmi + smoker + age.smoker + bmi.smoker', booktabs = TRUE, format = "latex") %>%
  kable_styling(font_size = 10, latex_options = "hold_position")

reg.tab1<- get_regression_table(model1)
reg1<- as.data.frame(reg.tab1)
```
\newpage

The assumptions of zero mean and constant variance for the full interaction model looks randomly scatterd across the explanatory variable age and the fitted values.  However, for bmi, the assumption of constant variablity is slightly dubious.  Furthermore, the assumption of normally distributed residuals seems to hold.  

From the results obtained in Table \ref{tab:fullmodel}, we can conclude that there is insufficient evidence that $\beta_{\mbox{age, smoker}}$ differs from zero, as the corresponding confidence interval contains zero (`r reg1[5,6]`, `r reg1[5,7]`).  Consequently, this term is eliminated and the following model with only one interaction term `bmi.smoker` is fitted to the data and the results obtained are shown in Table \ref{tab:bestmodel}:

```{r best, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}

best <- lm(charges ~ age + bmi + smoker + bmi*smoker, data = insur)

coeff <- best %>%
  coef() %>%
  as.numeric()

get_regression_table(best) %>%
  kable(digits = 3, caption = '\\label{tab:bestmodel} Parameter estimates obtained from the model charges = age + bmi + smoker + bmi.smoker', booktabs = TRUE, format = "latex") %>%
  kable_styling(font_size = 10, latex_options = "hold_position")

reg.tab2<- get_regression_table(best)
reg2<- as.data.frame(reg.tab2)

```

Table \ref{tab:bestmodel} shows that the confidence interval for the bmi (`r reg2[3,6]`, `r reg2[3,7]`) contains zero, implying that bmi is not statistically significantly related to insurance charges, when keeping all the other variables constant.  However, the interaction term between `bmi` and `smoker` is found to be significant, since the confidence interval (`r reg2[5,6]`, `r reg2[5,7]`) does not contain zero.  This is also confirmed from the plot shown on the right in Figure \ref{fig:scat}, since it shows graphically that bmi changes differently among smokers and non smokers.  This suggests that the best fitted model to predict the insurance charges is the model fitted in Table \ref{tab:bestmodel}.  In order to verify this, the model selection approach was also conducted below:

```{r modelselection, echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE}

model.comp.values.full <- glance(lm(charges ~ age + bmi + smoker + age*smoker + bmi*smoker, data = insur))

model.comp.values.m1 <- glance(lm(charges ~ age + bmi + smoker + bmi*smoker, data = insur))

model.comp.values.m2 <- glance(lm(charges ~ age + bmi + smoker, data = insur))

model.comp.values.m3 <- glance(lm(charges ~ age + smoker, data = insur))

model.comp.values.m4 <- glance(lm(charges ~ bmi + smoker, data = insur))

Models <- c('Full Model', 'Model 1', 'Model 2', 'Model 3', 'Model 4')

bind_rows(model.comp.values.full, model.comp.values.m1, model.comp.values.m2, model.comp.values.m3, model.comp.values.m4, .id = "Model") %>%
  select(Model, adj.r.squared, AIC, BIC) %>%
  mutate(Model = Models) %>%
   kable(caption = '\\label{tab:select} Model selection', booktabs = TRUE, format = "latex") %>%
  kable_styling(font_size = 10, latex_options = 'HOLD_position')
```

`Full Model` corresponds to the full interaction model, which was fitted in Table \ref{tab:fullmodel}, `Model 1` consists of only one interaction term between `bmi` and `smoke` shown in Table \ref{tab:bestmodel}, while `Model 2` is the parallel fitted model.  Finally, `Model 3` and `Model 4` corresponds to the models with `age` and `smoker`, and `bmi` and `smoker`, respectively.  Table \ref{tab:select} summarizes the Adjusted $R^{2}$, AIC and BIC values obtained for each of the above-mentioned models.  In particular, the best model would be the one with the largest Adjusted $R^{2}$ and the smallest AIC and BIC values, which in this case, this corresponds to `Model 1`.  This is in line with what was found to be the best model when the confidence intervals were considered.  

Hence, the equation of the best fitted model with the parameter estimates for the non smokers is as follows:

$$\widehat{\mbox{Charges}} = `r round(coeff[1],3)` + `r round(coeff[2],3)`\cdot{\mbox{age}} `r round(coeff[3],3)`\cdot{\mbox{bmi}} $$ 

while the regression line for smokers is given by:
$$\widehat{\mbox{Charges}} = `r round(coeff[1],3)` + `r round(coeff[2],3)`\cdot{\mbox{age}} `r round(coeff[3],3)`\cdot{\mbox{bmi}} `r round(coeff[4],3)` + `r round(coeff[5],3)`\cdot{\mbox{bmi}} = `r round(coeff[1]+coeff[4],3)` + `r round(coeff[2],3)`\cdot{\mbox{age}}+ `r round(coeff[3]+coeff[5],3)`\cdot{\mbox{bmi}}$$ 
For every one year increase in the age of the insured with constant bmi value, the corresponding insurance charges will increase by `r round(coeff[1],3)`, irrespective of whether the person smokes or not.  On the other hand, when age remains constant, an increase in bmi by one unit will result to a negative and a positive contribution to insurance charges for non smokers and smokers, respectively.  In particular, the health insurance charges will decrease by `r round(coeff[3],3)` for non smokers, which is in contrast to when the insured smokes, since it will increase drastically by `r round(coeff[3] + coeff[5],3)` for every one unit increase in bmi.  It should be noted that although the intercept for the smokers is smaller than the non smokers, the average change in the medical insurance charges with every one unit increase in bmi, is significantly larger for smokers than non smokers. 

In order for this analysis to be valid, the model assumptions corresponding to linear regression, should be satisfied.  The assumptions of zero mean and constant variance across the explanatory variables and the fitted values are checked in Figures \ref{fig:resid1} and \ref{fig:resid2}, respectively.

```{r residplot11, echo=FALSE,fig.width = 13, fig.align = "center", fig.cap = "\\label{fig:resid1} Residuals vs the explanatory variable age and bmi by Smoker.", message = FALSE, fig.pos="H"}


regression.points1 <- get_regression_points(best)

w1<-ggplot(regression.points1, aes(x = bmi, y = residual)) +
  geom_jitter(color="aquamarine3") +
  labs(x = "bmi", y = "Residual") +
  geom_hline(yintercept = 0, col = "blue", size = 1) +
  facet_wrap(~ smoker)

w2<-ggplot(regression.points1, aes(x = age, y = residual)) +
  geom_jitter(color="coral1") +
  labs(x = "age", y = "Residual") +
  geom_hline(yintercept = 0, col = "blue", size = 1) +
  facet_wrap(~ smoker)

grid.arrange(w2, w1, ncol =2)
```

The residuals in the scatterplot seem to be approximately evenly spread above and below the zero line for smokers and non smokers across all levels of the explanatory variables.  Hence, the assumption that the residuals have mean zero appears reasonable.  Moreover, the observations seem to be randomly scattered, implying constant variance, with the exception for the bmi related to smokers.  The latter could be due to the fact that there is a small number of smokers in the study (`r sum(insur$smoker=="yes")` smokers from Table \ref{tab:sum1}).  Next, Figure \ref {fig:resid2} shows two scatterplots of the residuals against fitted values by smoking status.  

```{r residplot2, echo=FALSE, out.width = '55%', fig.align = "center", fig.cap = "\\label{fig:resid2} Residuals vs the fitted values by Smoker.", message = FALSE, fig.pos="H"}
ggplot(regression.points1, aes(x = charges_hat, y = residual)) + 
  geom_point(color="coral1") +
  labs(x = "Fitted values", y = "Residual") +
  geom_hline(yintercept = 0, col = "blue", size = 1) +
  facet_wrap(~ smoker)
```
The plots in Figure \ref {fig:resid2} indicate that there are no obvious patterns in the residuals and thus, both assumptions of zero mean and constant variance seem to hold.

Finally, to assess whether the residuals are normally distributed, a histogram is plotted in Figure \ref {fig:resid3}.  The residuals for smokers seem to be bell-shaped and centered at zero, with the exception of one outlier, having a large positive residual.  On the other hand, the histogram for people who do not smoke is centered around zero and slightly skewed to the right.  Thus, the assumption of normally distributed random errors might be slightly dubious.  However, overall, both histograms appear to be realtively symmetrical and bell-shaped, and hence, the assumption of normally distributed random errors seems plausible for the best fitted model.

```{r residplot3, echo=FALSE, out.width= '56%', fig.align = "center", fig.cap = "\\label{fig:resid3} Histogram of residuals.", message = FALSE, fig.pos="H"}
ggplot(regression.points1, aes(x = residual)) + 
  geom_histogram(color = "white", fill="aquamarine3") +
  labs(x = "Residual") +
  facet_wrap(~ smoker)
```


# Conclusions {#sec:Conc}

- Limitations?

How to improve:

- A larger dataset would be better/preffered to judge the assumptions.
- Also, can consider transformations on our variables.
- More variables -> there seems to be some confounding factors




